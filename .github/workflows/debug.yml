name: Build Kivy Android APK In Debug Mode

on:
  workflow_dispatch:  # 手动触发构建

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 延长超时到60分钟
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 核心修复：修正依赖包名 + 确保sudo权限 + 分命令执行避免换行错误
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          # 基础依赖
          sudo apt-get install -y git zip unzip ant python3-pip autoconf automake libtool
          # 编译工具依赖
          sudo apt-get install -y pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev
          # JDK和基础工具
          sudo apt-get install -y curl unzip openjdk-17-jdk libltdl-dev
          # Kivy编译必需的图形/系统库（修正Ubuntu 24.04兼容的包名）
          sudo apt-get install -y libgl1-mesa-dev libgles2-mesa-dev
          sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev
          sudo apt-get install -y libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev
          sudo apt-get install -y libjpeg-dev libpng-dev libtiff-dev libx11-dev libxcursor-dev
          sudo apt-get install -y libxinerama-dev libxrandr-dev libxss-dev libxxf86vm-dev
          sudo apt-get clean

      # 自动同意Android SDK许可
      - name: Auto accept Android SDK licenses
        run: |
          mkdir -p $ANDROID_HOME/licenses
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/intel-android-extra-license
          mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
          cp $ANDROID_HOME/licenses/* ~/.buildozer/android/platform/android-sdk/licenses/

      # 强制安装二进制包，避免Kivy编译
      - name: Install Buildozer and dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --only-binary ":all:" buildozer==1.5.0 cython==0.29.33 \
            kivy==2.2.1 kivymd==1.2.0 paho-mqtt pyjnius \
            python-for-android==2023.2.10

      # 缓存依赖
      - name: Cache Buildozer dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            ./.buildozer
          key: buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-

      # 构建APK
      - name: Build APK with Buildozer (Debug Mode)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export P4A_BUILD_TOOLS_VERSION=33.0.2
          export P4A_ANDROID_API=33
          export P4A_MINSDK=21
          export P4A_NDK_VERSION=25b
          export BUILDOZER_ALLOW_PLATFORM_EXEC=1
          
          buildozer android clean
          buildozer -v android debug --log-level=2 2>&1 | tee buildozer.log
          
          mkdir -p bin
          find . -name "*.apk" -exec cp -f {} bin/ \; 2>/dev/null || echo "未找到APK文件"
          ls -la bin/

      # 上传产物
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-and-apk
          path: |
            bin/
            buildozer.log
            ./.buildozer/android/platform/build-armeabi-v7a/dists/*/*.apk
          if-no-files-found: warn
